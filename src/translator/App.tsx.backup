
import React, { useCallback, useEffect, useMemo, useState } from 'react';
import ReactMarkdown from 'react-markdown';
import remarkMath from 'remark-math';
import rehypeKatex from 'rehype-katex';
import type { TranslationHistoryEntry, LanguageOption } from '../types';

const DEFAULT_OUTPUT_MESSAGE = 'ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œâ€¦';
const HISTORY_STORAGE_KEY = 'doubaoTranslatorHistory';
const MAX_HISTORY_ITEMS = 5;
const DEBOUNCE_DELAY = 500;

const LANGUAGE_OPTIONS: LanguageOption[] = [
  { value: 'auto', label: 'è‡ªåŠ¨æ£€æµ‹' },
  { value: 'zh', label: 'ç®€ä½“ä¸­æ–‡' },
  { value: 'zh-Hant', label: 'ç¹é«”ä¸­æ–‡' },
  { value: 'en', label: 'English' },
  { value: 'ja', label: 'æ—¥æœ¬èª' },
  { value: 'ko', label: 'í•œêµ­ì–´' },
  { value: 'de', label: 'Deutsch' },
  { value: 'fr', label: 'FranÃ§ais' },
  { value: 'es', label: 'EspaÃ±ol' },
  { value: 'it', label: 'Italiano' },
  { value: 'pt', label: 'PortuguÃªs' },
  { value: 'ru', label: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' },
  { value: 'th', label: 'à¹„à¸—à¸¢' },
  { value: 'vi', label: 'Tiáº¿ng Viá»‡t' },
  { value: 'ar', label: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' },
  { value: 'cs', label: 'ÄŒeÅ¡tina' },
  { value: 'da', label: 'Dansk' },
  { value: 'fi', label: 'Suomi' },
  { value: 'hr', label: 'Hrvatski' },
  { value: 'hu', label: 'Magyar' },
  { value: 'id', label: 'Bahasa Indonesia' },
  { value: 'ms', label: 'Bahasa Melayu' },
  { value: 'nb', label: 'Norsk BokmÃ¥l' },
  { value: 'nl', label: 'Nederlands' },
  { value: 'pl', label: 'Polski' },
  { value: 'ro', label: 'RomÃ¢nÄƒ' },
  { value: 'sv', label: 'Svenska' },
  { value: 'tr', label: 'TÃ¼rkÃ§e' },
  { value: 'uk', label: 'Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°' },
];

const TARGET_LANGUAGE_OPTIONS = LANGUAGE_OPTIONS.filter(option => option.value !== 'auto');

interface TranslationResponse {
  success: boolean;
  translation?: string;
  error?: string;
  cached?: boolean;
}

const useDebouncedValue = <T,>(value: T, delay = DEBOUNCE_DELAY): T => {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);

  useEffect(() => {
    const timer = setTimeout(() => setDebouncedValue(value), delay);
    return () => clearTimeout(timer);
  }, [value, delay]);

  return debouncedValue;
};

const sendTranslationRequest = async (text: string, targetLanguage: string): Promise<TranslationResponse> => {
  if (!text?.trim()) {
    throw new Error('è¯·è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬');
  }

  const runtime = typeof chrome !== 'undefined' ? chrome.runtime : null;

  if (!runtime?.sendMessage) {
    throw new Error('Chrome runtime ä¸å¯ç”¨ï¼Œåœ¨æ‰©å±•ç¯å¢ƒä¸­æ‰“å¼€æ­¤é¡µé¢ã€‚');
  }

  return new Promise((resolve, reject) => {
    runtime.sendMessage(
      {
        type: 'TRANSLATE_TEXT',
        payload: { text, targetLanguage },
      },
      (response: TranslationResponse) => {
        if (chrome.runtime.lastError) {
          reject(new Error(chrome.runtime.lastError.message));
          return;
        }

        if (!response?.success) {
          reject(new Error(response?.error || 'ç¿»è¯‘å¤±è´¥'));
          return;
        }

        resolve(response);
      },
    );
  });
};

const App: React.FC = () => {
  const [sourceLang, setSourceLang] = useState<string>('auto');
  const [targetLang, setTargetLang] = useState<string>('zh');
  const [inputText, setInputText] = useState<string>('');
  const [translation, setTranslation] = useState<string>('');
  const [isTranslating, setIsTranslating] = useState<boolean>(false);
  const [statusMessage, setStatusMessage] = useState<string>('å‡†å¤‡å°±ç»ª');
  const [history, setHistory] = useState<TranslationHistoryEntry[]>([]);
  const [fontSize, setFontSize] = useState<number>(16);
  const [copied, setCopied] = useState<boolean>(false);

  const debouncedText = useDebouncedValue(inputText);
  const charCount = useMemo(() => inputText.length, [inputText]);

  const persistHistory = useCallback((
    text: string, 
    translatedText: string, 
    source: string, 
    target: string, 
    setHistoryState: React.Dispatch<React.SetStateAction<TranslationHistoryEntry[]>>
  ) => {
    setHistoryState(prev => {
      const entry: TranslationHistoryEntry = {
        id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
        sourceText: text,
        translatedText,
        sourceLang: source,
        targetLang: target,
        timestamp: new Date().toISOString(),
      };

      const next = [entry, ...prev].slice(0, MAX_HISTORY_ITEMS);
      chrome?.storage?.local?.set({ [HISTORY_STORAGE_KEY]: next });
      return next;
    });
  }, []);

  useEffect(() => {
    const storage = chrome?.storage?.local;
    if (!storage) return;

    storage.get([HISTORY_STORAGE_KEY], result => {
      setHistory(result?.[HISTORY_STORAGE_KEY] ?? []);
    });
  }, []);

  useEffect(() => {
    const storage = chrome?.storage?.local;
    if (!storage) return;

    storage.get(['pending_translation'], result => {
      const pending = result?.pending_translation;
      if (pending) {
        setInputText(pending);
        setStatusMessage('å·²è½½å…¥é€‰ä¸­æ–‡æœ¬ï¼Œå‡†å¤‡ç¿»è¯‘');
        storage.remove('pending_translation');
      }
    });
  }, []);

  useEffect(() => {
    if (!copied) return;
    const timeout = setTimeout(() => setCopied(false), 1500);
    return () => clearTimeout(timeout);
  }, [copied]);

  // Compute derived state for empty text
  const trimmedText = useMemo(() => debouncedText.trim(), [debouncedText]);
  const isEmptyText = !trimmedText;

  useEffect(() => {
    if (isEmptyText) {
      setTranslation('');
      setStatusMessage('è¯·è¾“å…¥æ–‡æœ¬ä»¥å¼€å§‹ç¿»è¯‘');
      setIsTranslating(false);
      return;
    }

    let cancelled = false;

    setIsTranslating(true);
    setStatusMessage('ç¿»è¯‘ä¸­â€¦');

    sendTranslationRequest(trimmedText, targetLang)
      .then(result => {
        if (cancelled) return;

        setTranslation(result.translation || '');
        setStatusMessage(result.cached ? 'å·²ä»ç¼“å­˜åŠ è½½ç¿»è¯‘' : 'ç¿»è¯‘å®Œæˆ');
        persistHistory(trimmedText, result.translation || '', sourceLang, targetLang, setHistory);
      })
      .catch(error => {
        if (cancelled) return;
        console.error('Translation error:', error);
        setStatusMessage(error.message || 'ç¿»è¯‘å¤±è´¥');
      })
      .finally(() => {
        if (cancelled) return;
        setIsTranslating(false);
      });

    return () => {
      cancelled = true;
    };
  }, [trimmedText, targetLang, sourceLang, persistHistory, isEmptyText]);

  const handleSwapLanguages = () => {
    const newSource = targetLang;
    const candidateTarget = sourceLang === 'auto' ? targetLang : sourceLang;
    setSourceLang(newSource);
    setTargetLang(candidateTarget === 'auto' ? 'zh' : candidateTarget);
  };

  const handleClear = () => {
    setInputText('');
    setTranslation('');
    setStatusMessage('å·²æ¸…ç©º');
  };

  const handleCopy = async () => {
    if (!translation) return;
    try {
      await navigator.clipboard.writeText(translation);
      setCopied(true);
      setStatusMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
      console.error('Copy failed:', error);
      setStatusMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™');
    }
  };

  const handleReuseHistory = (entry: TranslationHistoryEntry) => {
    setInputText(entry.sourceText);
    setTargetLang(entry.targetLang);
    setSourceLang(entry.sourceLang);
    setStatusMessage('å·²è½½å…¥å†å²è®°å½•ï¼Œå‡†å¤‡ç¿»è¯‘');
  };

  const inputFontStyle = useMemo(
    () => ({
      fontSize: `${fontSize}px`,
      lineHeight: '1.6',
    }),
    [fontSize],
  );

  const getLabel = (value: string): string => {
    return LANGUAGE_OPTIONS.find(option => option.value === value)?.label || value;
  };

  return (
    <div className="min-h-screen bg-[#1e1e1e] text-[#e0e0e0] font-['PingFang_SC','Noto_Sans_SC','Maple_Mono_NF_CN',sans-serif]">
      <div className='mx-auto flex min-h-screen w-[95%] max-w-[1920px] flex-col'>
        <header className='border-b border-[#333] bg-[#1e1e1e] px-10 py-6 shadow-[0_20px_60px_rgba(0,0,0,0.65)]'>
          <div className='flex flex-col gap-3'>
            <p className='text-xs uppercase tracking-[0.75em] text-[#667eea]'>Doubao Translator</p>
            <div className='flex flex-wrap items-end justify-between gap-4'>
              <div>
                <h1 className='text-3xl font-semibold text-white'>ARK è±†åŒ…ç¿»è¯‘å™¨</h1>
                <p className='text-sm text-[#9aa0a6]'>
                  æ²‰æµ¸å¼åŒæ ä½“éªŒ Â· Markdown & KaTeX æ”¯æŒ Â· Volcengine Doubao
                </p>
              </div>
              <div className='flex items-center gap-6 text-sm text-[#9aa0a6]'>
                <span>
                  æºè¯­è¨€ï¼š<strong className='text-white'>{getLabel(sourceLang)}</strong>
                </span>
                <span>
                  ç›®æ ‡è¯­è¨€ï¼š<strong className='text-white'>{getLabel(targetLang)}</strong>
                </span>
              </div>
            </div>
          </div>
        </header>

        <div className='flex flex-1 flex-col bg-[#1e1e1e]'>
          <div className='translation-area flex flex-1 min-h-0'>
            <section className='input-section flex min-w-0 flex-1 flex-col border-r border-[#333] p-6'>
              <div className='section-header mb-6 flex items-center justify-between border-b border-[#333] pb-4'>
                <div className='language-selector flex items-center gap-4 text-sm'>
                  <span className='lang-label text-base font-semibold'>æºè¯­è¨€</span>
                  <select
                    id='sourceLang'
                    className='rounded-lg border border-[#333] bg-[#2d2d2d] px-4 py-2 text-sm focus:border-[#667eea] focus:outline-none'
                    value={sourceLang}
                    onChange={event => setSourceLang(event.target.value)}
                  >
                    {LANGUAGE_OPTIONS.map(option => (
                      <option key={option.value} value={option.value}>
                        {option.label}
                      </option>
                    ))}
                  </select>
                </div>
                <button
                  type='button'
                  onClick={handleSwapLanguages}
                  className='swap-btn inline-flex h-10 w-10 items-center justify-center rounded-full bg-[#333] text-white transition hover:bg-[#444]'
                  title='äº¤æ¢è¯­è¨€'
                >
                  â‡„
                </button>
              </div>

              <textarea
                className='text-area min-h-[420px] w-full flex-1 resize-none rounded-lg border-2 border-[#333] bg-[#2d2d2d] p-5 text-base text-[#e0e0e0] placeholder:text-[#888] shadow-[0_12px_35px_rgba(0,0,0,0.45)] focus:border-[#667eea] focus:outline-none'
                placeholder='è¯·è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬...\n\næç¤ºï¼šè¾“å…¥æ–‡æœ¬å 0.5s å†…è‡ªåŠ¨ç¿»è¯‘ï¼Œæ— éœ€æŒ‰é’®ã€‚\næ”¯æŒ LaTeX æ•°å­¦å…¬å¼ï¼š$...$ è¡Œå†…ï¼Œ$$...$$ å—çº§ã€‚'
                value={inputText}
                onChange={event => setInputText(event.target.value)}
                style={inputFontStyle}
              />

              <div className='input-footer mt-4 flex flex-wrap items-center justify-between gap-4 text-sm text-[#9aa0a6]'>
                <div className='char-count text-xs uppercase tracking-[0.2em]'>
                  <span className='text-white'>{charCount}</span> å­—ç¬¦
                </div>
                <div className='font-size-control flex items-center gap-4'>
                  <label htmlFor='fontSizeSlider' className='text-sm font-semibold text-[#e0e0e0]'>
                    å­—ä½“å¤§å°
                  </label>
                  <input
                    id='fontSizeSlider'
                    type='range'
                    min='12'
                    max='26'
                    value={fontSize}
                    onChange={event => setFontSize(Number(event.target.value))}
                    className='gradient-slider'
                  />
                  <span className='font-size-value w-12 text-right text-sm text-[#e0e0e0]'>
                    {fontSize}px
                  </span>
                </div>
                <button
                  type='button'
                  onClick={handleClear}
                  className='clear-btn rounded-full border border-transparent bg-gradient-to-r from-[#667eea] to-[#764ba2] px-6 py-2 text-sm font-semibold text-white shadow-[0_10px_25px_rgba(102,126,234,0.35)] transition hover:opacity-90'
                >
                  æ¸…ç©º
                </button>
              </div>
            </section>

            <section className='output-section flex min-w-0 flex-1 flex-col p-6'>
              <div className='section-header mb-6 flex items-center justify-between border-b border-[#333] pb-4'>
                <div className='language-selector flex items-center gap-4 text-sm'>
                  <span className='lang-label text-base font-semibold'>ç›®æ ‡è¯­è¨€</span>
                  <select
                    id='targetLang'
                    className='rounded-lg border border-[#333] bg-[#2d2d2d] px-4 py-2 text-sm focus:border-[#667eea] focus:outline-none'
                    value={targetLang}
                    onChange={event => setTargetLang(event.target.value)}
                  >
                    {TARGET_LANGUAGE_OPTIONS.map(option => (
                      <option key={option.value} value={option.value}>
                        {option.label}
                      </option>
                    ))}
                  </select>
                </div>
                <button
                  type='button'
                  onClick={handleCopy}
                  disabled={!translation}
                  className='icon-btn inline-flex h-10 w-10 items-center justify-center rounded-full bg-[#333] text-lg text-white transition hover:bg-[#444] disabled:cursor-not-allowed disabled:opacity-40'
                  aria-live='polite'
                  title='å¤åˆ¶ç¿»è¯‘ç»“æœ'
                >
                  {copied ? 'âœ“' : 'ğŸ“‹'}
                </button>
              </div>

              <div className='relative flex-1'>
                {isTranslating && (
                  <div className='pointer-events-none absolute inset-x-0 top-0 flex justify-end pr-4'>
                    <div className='mt-[-12px] flex items-center gap-2 rounded-full border border-[#667eea]/40 bg-[#667eea]/15 px-4 py-1 text-xs text-[#c3cbff] shadow-[0_10px_30px_rgba(102,126,234,0.45)]'>
                      <span className='h-2 w-2 animate-pulse rounded-full bg-[#667eea]' />
                      ç¿»è¯‘ä¸­â€¦
                    </div>
                  </div>
                )}

                <div
                  className='markdown-body min-h-[420px] rounded-lg border-2 border-[#333] bg-[#252525] p-5 text-base leading-relaxed text-[#e0e0e0] shadow-[0_12px_35px_rgba(0,0,0,0.45)]'
                  style={{ ...inputFontStyle, overflowY: 'auto' }}
                >
                  <ReactMarkdown
                    remarkPlugins={[remarkMath]}
                    rehypePlugins={[rehypeKatex]}
                    components={{
                      // Custom components if needed
                    }}
                  >
                    {translation || DEFAULT_OUTPUT_MESSAGE}
                  </ReactMarkdown>
                </div>
              </div>
            </section>
          </div>

          <section className='history-section border-t border-[#333] bg-[#1e1e1e] px-8 py-8'>
            <details className='history-details' open>
              <summary className='flex cursor-pointer items-center gap-3 text-lg font-semibold text-white'>
                å†å²è®°å½•
              </summary>
              <div
                className={`history-list mt-6 flex flex-col gap-4 ${history.length === 0 ? 'empty' : ''}`}
              >
                {history.length === 0 && <p className='history-empty text-sm'>æš‚æ— å†å²è®°å½•</p>}
                {history.map(entry => (
                  <article
                    key={entry.id}
                    className='history-item border border-[#333] bg-[#2d2d2d]'
                  >
                    <div className='history-item-header'>
                      <div className='history-meta'>
                        {getLabel(entry.sourceLang)} â†’ {getLabel(entry.targetLang)}
                      </div>
                      <time className='history-time' dateTime={entry.timestamp}>
                        {new Date(entry.timestamp).toLocaleString()}
                      </time>
                    </div>
                    <div className='history-text-block'>
                      <span className='history-text-label'>åŸæ–‡</span>
                      <p className='history-text'>{entry.sourceText}</p>
                    </div>
                    <div className='history-text-block'>
                      <span className='history-text-label'>è¯‘æ–‡</span>
                      <p className='history-text'>{entry.translatedText}</p>
                    </div>
                    <div className='history-actions'>
                      <button
                        type='button'
                        className='history-reuse'
                        onClick={() => handleReuseHistory(entry)}
                      >
                        å†æ¬¡ç¿»è¯‘
                      </button>
                    </div>
                  </article>
                ))}
              </div>
            </details>
          </section>

          <footer className='status-bar border-t border-[#333] bg-[#1e1e1e] px-8 py-4 text-sm text-[#e0e0e0]'>
            <div className='flex flex-wrap items-center justify-between gap-6'>
              <div className='auto-translate flex items-center gap-3'>
                <span className='font-semibold'>è‡ªåŠ¨ç¿»è¯‘</span>
                <div className='inline-flex items-center gap-2 rounded-full border border-[#333] bg-[#2d2d2d] px-3 py-1 text-xs text-[#a0a0a0]'>
                  <span className='relative inline-flex h-5 w-10 items-center rounded-full bg-gradient-to-r from-[#667eea] to-[#764ba2]'>
                    <span className='ml-auto mr-1 inline-flex h-4 w-4 items-center justify-center rounded-full bg-white text-[10px] font-semibold text-[#667eea]'>
                      ON
                    </span>
                  </span>
                  å·²å¯ç”¨
                </div>
              </div>
              <div className='font-size-control flex items-center gap-3 text-sm'>
                çŠ¶æ€ï¼š<span className='text-white'>{statusMessage}</span>
              </div>
              <div className='text-xs uppercase tracking-[0.4em] text-[#9aa0a6]'>
                Powered by Volcengine Doubao
              </div>
            </div>
          </footer>
        </div>
      </div>
    </div>
  );
};

export default App;